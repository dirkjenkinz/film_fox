{% extends "showreel/parent.njk" %}
{% block page %}

  <!-- Hidden data elements -->
  <div class='row top'>
    <p id='slugList' hidden="hidden">{{ slugList }}</p>
    <p id='noteList' hidden="hidden">{{ noteList }}</p>
    <p id='highestElement' hidden="hidden">{{ highestElement }}</p>
    <!-- Loop to iterate through script elements and display type -->
    {% for i in range(0, script.length) %}
      <p id='type_{{ i }}' hidden="hidden">{{ script[i].type }}</p>
    {% endfor %}
    <div class="col-md-12" id='message' hidden="hidden" style='background:white; text-align: center; colour:red;'>
      <br><br><br>
      <h1 style='color:red;'>Processing... Please wait.</h1>
      <br><br><br>
    </div>
  </div>

  <div class='row' id='character-handling' hidden="hidden">
    <div class='col-md-3' id='add-characters'>
      <span class='char-box'>Click character to add to scene</span>
      <table class='table-bordered table-sm table-dark table-grid' style='table-layout: fixed;' id='tab_characters'>
        {% for i in range(0, characters.length) -%}
          <tr>
            <td>
              <button class='btn-add-character' id='btn-add-character' value='{{ characters[i] }}'>
                {{ characters[i] }}
              </button>
            </td>
          </tr>
        {% endfor %}
      </table>
    </div>
    <div class='col-md-3' id='delete-characters'>
      <span class='char-box'>Click character to remove from scene</span>
      <table class='table-bordered table-sm table-dark table-grid' style='table-layout: fixed;' id='tab_characters'>
        {% for i in range(0, characterList.length) -%}
          {% if characterList[i] !== 'NARRATOR' %}
            <tr>
              <td>
                <button class='btn-delete-character' id='btn-delete-character' value='{{ characterList[i] }}'>
                  {{ characterList[i] }}
                </button>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </table>
    </div>
    <div class='col-md-6'>
      <br>
      <button id='btn-hide-characters'>
        RETURN
      </button>
    </div>
  </div>

  <div class='row' id='main'>
    <div class='col-md-5'>
      <div class='slidecontainer'>
        SCENE
        <span id="output">{{ sceneNumber }}
          (element
          {{ elementNumber }}):&nbsp;
          {{ slug }}
        </span>
      </div>

      <input type="range" min="0" max="{{ highestScene }}" value="{{ sceneNumber }}" id='slider-scene'/>
      NOTE:<br>
      <textarea id="input-note" name="note" rows="3" cols="60">{{ note }}</textarea>

      {{ element.image }}

      {% if element.type === 'movie' %}
        <video width='420' height='240' controls='controls' autoplay='autoplay' id='image_{{ i }}' class='image' muted='muted'>
          <source src='../data/{{ title }}/vision/images/{{ element.image }}' type='video/mp4'>
        </video>
      {% elseif element.type === 'still' %}
        <img width='420' height='240' src='../data/{{ title }}/vision/images/{{ element.image }}' id='image_{{ i }}' class='img' alt='{{ script[i].image }}'>
      {% else %}
        <h2 class='data-showreel'>NO IMAGE</h2>
      {% endif %}
      <button class='btn-change' style='margin-right: 80px;' id='change_{{ i }}' value='{{ i }}'>
        Change Image
      </button>
    </div>

    <div class='col-md-4'>
      <!-- 2nd column -->
      <div class='fox-speaker' style='margin-left: 30px;'>
        <!-- Display sound controls or message if sound generation failed -->
        {% if element.sound %}
          <div id="master-play" style="width: 100%;"></div>
        {% elseif msg === 'Failed' %}
          <h5 class='data-showreel' style='text-align: center;'>Sound generation failed</h5>
        {% else %}
          <h5 class='data-showreel' style='text-align: center;'>NO SOUND</h5>
        {% endif %}
        <p style='text-align: center; font-size: 120%; font-weight: bold; color:white; background:black;'>Voice:
          {{ element.voice }}</p>
        <button id="play-pause">Play Sound/Pause Sound</button>
        <button id="btn-mute">{{ mute }}
        </button>
        <!-- Button to delete or generate sound -->
        {% if audio %}
          <button class='btn-del' id='del_{{ elementNumber }}' value='{{ element.sound }}'>
            Delete
            {{ element.sound }}
          </button>
        {% else %}
          {% if element.voice %}
            <button class='btn-gen' id='gen_{{ elementNumber }}'>
              Generate
            </button>
          {% else %}
            <button disabled="disabled">
              &nbsp;
            </button>
          {% endif %}
        {% endif %}
        <br>
      </div>
      <div class='row'>
        <div class='col-md-6'>
          {% if sceneNumber > 0 %}
            <button id='btn-previous-element'>
              Previous Element
            </button>
          {% endif %}
        </div>
        <div class='col-md-6'>
          <button id='btn-next-element'>
            Next Element
          </button>
        </div>
      </div>
      <div class='box' id='box-dialogue'>
        <!-- Display character dialogues with or without parenthetical -->
        {% if element.character === 'NARRATOR' %}
          <p style='text-align: center; font-weight: bold;'></p>
          <p>{{ element.dialogue }}</p>
        {% else %}
          <p style='text-align: center; font-weight: bold;'>{{ element.character }}</p>
          {% if element.parenthetical %}
            <p style='text-align: center;'>({{ element.parenthetical }})</p>
          {% endif %}
          <p>{{ element.dialogue }}</p>
        {% endif %}
      </div>
      <div class='row'>
        <div class='col-md-6'>
          {% if sceneNumber > 0%}
            <button id='btn-previous-scene'>
              Previous Scene
            </button>
          {% endif %}
        </div>
        <div class='col-md-6'>
          <button id='btn-next-scene'>
            Next Scene
          </button>
        </div>
      </div>
    </div>

    <div class='col-md-3'>
      <div id='box-character'>
        <!-- Buttons to add or delete characters -->
        <button id='btn-show-characters'>
          CHARACTERS
        </button>
        <!-- Display characters in the scene -->
        <br>
        {% for i in range(0, characterList.length) -%}
          {% if characterList[i] !== 'NARRATOR' %}
            {% if i < (characterList.length - 1) %}
              {{ characterList[i] }}<br>
            {% else %}
              {{ characterList[i] }}
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
  <div class='row'>
    &nbsp;
  </div>

  <div style="height: 200px; overflow: auto;">
    <div class='row' id='shot-list'>

      <div class='col-md-1'></div>
      <div class='col-md-10'>
        <table class='table-bordered table-sm table-dark table-grid' style='table-layout: fixed;'>
          <thead class="thead-light">
            <tr>
              <th>#</th>
              <th>Shot</th>
              <th>Angle</th>
              <th>Move</th>
              <th>Audio</th>
              <th>Subject</th>
              <th>Description</th>
            </tr>
          </thead>
          {% for i in range(0, shots.length) %}
            <tr>
              <td>{{i}}</td>
              <td>{{shots[i].shot}}</td>
              <td>{{shots[i].angle}}</td>
              <td>{{shots[i].move}}</td>
              <td>{{shots[i].audio}}</td>
              <td>{{shots[i].subject}}</td>
              <td>{{shots[i].description}}</td>
            </tr>
          {% endfor %}
        </table>
      </div>
      <div class='col-md-1'></div>
    </div>
  </div>

  <div class='row'>
    &nbsp;
  </div>

  <div class='row'>
    <div class='col-md-1'></div>
    <div class='col-md-10'>
      <button class="accordion">Scene Breakdown</button>
      <div class="panel">
        {% for i in range(0, breakdown.length) %}
          <h1>{{breakdown[i][0]}}</h1>
          {% for j in range(1, breakdown[i].length) %}
            {{breakdown[i][j]}}<br>
            {%endfor%}
          {% endfor %}
        </div>
      </div>
      <div class='col-md-1'></div>
    </div>

    <!-- Include scripts -->
    <script>
      $(document).ready(function () {
        // Create a new Howler.js sound instance
        let sound = new Howl({
          src: ['{{ audio }}'],
          html5: true,
          format: [
            'ogg', 'mp3'
          ],
          autoplay: true, // Autoplay enabled
          mute:{% if mute == 'MUTE' %}false
          {% else %}
            true{% endif %}
        });

        // Play/Pause button functionality
        $('#play-pause').click(function () {
          if (sound.playing()) {
            sound.pause();
          } else {
            sound.play();
          }
        });
      });

      var acc = document.getElementsByClassName("accordion");
      var i;

      for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function () {
          /* Toggle between adding and removing the "active" class,
    to highlight the button that controls the panel */
          this
            .classList
            .toggle("active");

          /* Toggle between hiding and showing the active panel */
          var panel = this.nextElementSibling;
          if (panel.style.display === "block") {
            panel.style.display = "none";
          } else {
            panel.style.display = "block";
          }
        });
      }
    </script>
    <script src='../js/showreel/parent.js'></script>
    <script src='../js/showreel/showreel.js'></script>
  {% endblock %}